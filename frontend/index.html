<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>College Chatbot</title>

    <!-- Fonts & Tailwind -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for Markdown Rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }

        /* Message Bubble Styles */
        .message-bubble {
            border-radius: 1.25rem;
            padding: 1rem 1.25rem;
            max-width: 85%;
            word-wrap: break-word;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Markdown Styles within Bubbles */
        .markdown-body ul,
        .markdown-body ol {
            padding-left: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .markdown-body ul {
            list-style-type: disc;
        }

        .markdown-body ol {
            list-style-type: decimal;
        }

        .markdown-body p {
            margin-bottom: 0.75rem;
        }

        .markdown-body p:last-child {
            margin-bottom: 0;
        }

        .markdown-body strong {
            font-weight: 600;
            color: inherit;
        }

        .markdown-body a {
            color: #2563eb;
            text-decoration: underline;
        }

        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3 {
            font-weight: 600;
            margin-top: 0.5rem;
            margin-bottom: 0.25rem;
        }

        /* Typing Animation */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 0.5rem 0.75rem;
            border-radius: 1rem;
            background-color: #e5e7eb;
            width: fit-content;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #6b7280;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Scrollbar */
        #messages::-webkit-scrollbar {
            width: 6px;
        }

        #messages::-webkit-scrollbar-track {
            background: transparent;
        }

        #messages::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }

        /* Fade In Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>

<body class="flex items-center justify-center h-screen bg-gray-100 p-4">

    <!-- Chat Icon -->
    <button id="chat-icon"
        class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-16 h-16 text-3xl shadow-xl transition-transform hover:scale-105 active:scale-95 flex items-center justify-center z-50">
        üí¨
    </button>

    <!-- Chat Box -->
    <div id="chat-box"
        class="fixed bottom-24 right-6 w-full max-w-sm h-[80vh] max-h-[600px] bg-white rounded-2xl shadow-2xl flex flex-col scale-0 opacity-0 transition-all duration-300 origin-bottom-right z-40 overflow-hidden border border-gray-100">

        <!-- Header -->
        <div
            class="px-5 py-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white flex justify-between items-center bg-blue-600 shadow-sm">
            <div class="flex items-center gap-3">
                <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                <h2 class="text-lg font-semibold tracking-wide">College Assistant</h2>
            </div>
            <div class="flex items-center gap-2">
                <button id="settings-btn"
                    class="hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center transition-colors"
                    title="Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
                <button id="close-chat"
                    class="hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center transition-colors">‚úï</button>
            </div>
        </div>

        <!-- Settings Modal (Absolute positioning within chatbox) -->
        <div id="settings-modal"
            class="absolute inset-0 bg-white/95 backdrop-blur-sm z-50 transform translate-y-full transition-transform duration-300 flex flex-col hidden dark:bg-gray-900/95 dark:text-white">
            <div class="px-5 py-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                <h3 class="font-semibold text-lg">Settings</h3>
                <button id="close-settings"
                    class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">‚úï</button>
            </div>

            <div class="p-5 space-y-6 overflow-y-auto flex-1">
                <!-- Language -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Language</label>
                    <select id="language-select"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500 bg-white dark:bg-gray-800 dark:border-gray-700">
                        <option value="en">English</option>
                        <option value="hi">Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)</option>
                        <option value="te">Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
                    </select>
                </div>

                <!-- Voice Output -->
                <div class="flex items-center justify-between">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Voice Output</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Read answers aloud</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="voice-toggle" class="sr-only peer">
                        <div
                            class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                        </div>
                    </label>
                </div>

                <!-- Speech Rate -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Speech Rate: <span id="rate-value">1.0</span>x
                    </label>
                    <input type="range" id="rate-slider" min="0.5" max="2" step="0.1" value="1"
                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                </div>

                <!-- Theme -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Theme</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button
                            class="theme-btn border border-gray-200 rounded-lg p-2 text-sm hover:bg-gray-50 dark:border-gray-600 dark:hover:bg-gray-800 transition-colors bg-blue-50 border-blue-500 text-blue-700"
                            data-theme="light">Light</button>
                        <button
                            class="theme-btn border border-gray-200 rounded-lg p-2 text-sm hover:bg-gray-50 dark:border-gray-600 dark:hover:bg-gray-800 transition-colors"
                            data-theme="dark">Dark</button>
                        <button
                            class="theme-btn border border-gray-200 rounded-lg p-2 text-sm hover:bg-gray-50 dark:border-gray-600 dark:hover:bg-gray-800 transition-colors"
                            data-theme="system">System</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div id="messages"
            class="flex-1 p-5 overflow-y-auto space-y-4 bg-gray-50/50 dark:bg-gray-900 transition-colors">
            <!-- Welcome Message -->
            <div class="flex justify-start animate-fade-in">
                <div
                    class="message-bubble bg-white text-gray-800 border border-gray-200 dark:bg-gray-800 dark:text-gray-100 dark:border-gray-700">
                    <div class="markdown-body">
                        <p>Hello! I am your <strong>College Buddy</strong> üëã</p>
                        <p>Ask me about:</p>
                        <ul>
                            <li>Admissions & Eligibility</li>
                            <li>Courses & Departments</li>
                            <li>Placements & Facilities</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar (Loading State) -->
        <div id="status-bar"
            class="px-4 py-1 text-xs font-medium text-blue-600 bg-blue-50 hidden flex items-center gap-2 dark:bg-gray-800 dark:text-blue-400">
            <svg class="animate-spin h-3 w-3 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            <span id="status-text">Thinking...</span>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-white border-t border-gray-100 dark:bg-gray-900 dark:border-gray-800">
            <div
                class="flex items-center gap-2 bg-gray-100 rounded-full px-4 py-2 border border-transparent focus-within:border-blue-500 focus-within:bg-white transition-all dark:bg-gray-800 dark:focus-within:bg-gray-800 dark:focus-within:border-blue-500 text-gray-700 dark:text-gray-100">
                <input id="user-input"
                    class="flex-1 bg-transparent border-none focus:outline-none placeholder-gray-400 text-sm py-1 dark:text-white"
                    placeholder="Type your question..." />

                <!-- Mic Button -->
                <button id="mic-button"
                    class="text-gray-500 hover:text-blue-600 p-2 rounded-full transition-colors active:scale-90"
                    title="Voice Input">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                </button>

                <button id="send-button"
                    class="bg-blue-600 hover:bg-blue-700 text-white rounded-full p-2 w-8 h-8 flex items-center justify-center transition-transform active:scale-90 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
            <div class="text-center mt-2">
                <p class="text-[10px] text-gray-400">AI can make mistakes. Check important info.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {

            /* ================= BACKEND CONFIG ================= */
            const backendUrl = "http://127.0.0.1:8000/query";
            let sessionId = null;

            /* ================= ELEMENTS ================= */
            const chatIcon = document.getElementById("chat-icon");
            const chatBox = document.getElementById("chat-box");
            const closeChat = document.getElementById("close-chat");
            const messagesDiv = document.getElementById("messages");
            const userInput = document.getElementById("user-input");
            const sendButton = document.getElementById("send-button");
            const statusBar = document.getElementById("status-bar");
            const statusText = document.getElementById("status-text");

            /* ================= SETTINGS LOGIC ================= */

            // Elements
            const settingsBtn = document.getElementById("settings-btn");
            const settingsModal = document.getElementById("settings-modal");
            const closeSettings = document.getElementById("close-settings");
            const languageSelect = document.getElementById("language-select");
            const voiceToggle = document.getElementById("voice-toggle");
            const rateSlider = document.getElementById("rate-slider");
            const rateValue = document.getElementById("rate-value");
            const themeBtns = document.querySelectorAll(".theme-btn");

            // State
            let settings = {
                language: 'en',
                voiceEnabled: false,
                speechRate: 1.0,
                theme: 'light' // light, dark, system
            };

            // Load Settings
            const loadSettings = () => {
                const saved = localStorage.getItem("collegeBuddySettings");
                if (saved) {
                    settings = { ...settings, ...JSON.parse(saved) };
                }

                // Apply Settings
                languageSelect.value = settings.language;
                voiceToggle.checked = settings.voiceEnabled;
                rateSlider.value = settings.speechRate;
                rateValue.textContent = settings.speechRate;
                applyTheme(settings.theme);
                updatePlaceholder(settings.language);
            };

            const saveSettings = () => {
                localStorage.setItem("collegeBuddySettings", JSON.stringify(settings));
            };

            // Modal Handlers
            const toggleSettings = () => {
                if (settingsModal.classList.contains("hidden")) {
                    settingsModal.classList.remove("hidden");
                    settingsModal.classList.remove("translate-y-full");
                } else {
                    settingsModal.classList.add("translate-y-full");
                    setTimeout(() => settingsModal.classList.add("hidden"), 300);
                }
            };

            settingsBtn.onclick = toggleSettings;
            closeSettings.onclick = toggleSettings;

            // Theme Logic
            const applyTheme = (theme) => {
                settings.theme = theme;

                // Update Buttons
                themeBtns.forEach(btn => {
                    const btnTheme = btn.dataset.theme;
                    if (btnTheme === theme) {
                        btn.classList.add("bg-blue-50", "border-blue-500", "text-blue-700");
                        btn.classList.remove("border-gray-200", "hover:bg-gray-50", "dark:border-gray-600", "dark:hover:bg-gray-800");
                    } else {
                        btn.classList.remove("bg-blue-50", "border-blue-500", "text-blue-700");
                        btn.classList.add("border-gray-200", "hover:bg-gray-50", "dark:border-gray-600", "dark:hover:bg-gray-800");
                    }
                });

                // Apply to DOM
                const isDark = theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
                if (isDark) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                saveSettings();
            };

            themeBtns.forEach(btn => {
                btn.onclick = () => applyTheme(btn.dataset.theme);
            });

            // Voice & Rate Logic
            voiceToggle.onchange = (e) => {
                settings.voiceEnabled = e.target.checked;
                if (!settings.voiceEnabled) {
                    window.speechSynthesis.cancel();
                }
                saveSettings();
            };

            rateSlider.oninput = (e) => {
                settings.speechRate = parseFloat(e.target.value);
                rateValue.textContent = settings.speechRate;
                saveSettings();
            };

            // TTS Function
            const speakText = (text) => {
                if (!settings.voiceEnabled) return;

                // Clean markdown for speech
                const cleanText = text.replace(/[*_#`]/g, '').replace(/\[(.*?)\]\(.*?\)/g, '$1');

                window.speechSynthesis.cancel(); // Stop overlap
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.rate = settings.speechRate;

                // Select voice based on language
                const voices = window.speechSynthesis.getVoices();
                let voice = null;

                if (settings.language === 'hi') {
                    voice = voices.find(v => v.lang.includes('hi'));
                } else if (settings.language === 'te') {
                    voice = voices.find(v => v.lang.includes('te'));
                }

                // Fallback to English/Default if specific lang voice not found (common for Telugu)
                // or if it's English
                if (!voice && settings.language === 'en') {
                    voice = voices.find(v => v.lang.includes('en'));
                }

                if (voice) utterance.voice = voice;

                window.speechSynthesis.speak(utterance);
            };


            /* ================= UI HELPERS ================= */
            const toggleChat = () => {
                chatBox.classList.toggle("scale-0");
                chatBox.classList.toggle("opacity-0");
                if (!chatBox.classList.contains("scale-0")) {
                    setTimeout(() => userInput.focus(), 300);
                }
            };

            const scrollToBottom = () => {
                messagesDiv.scrollTo({ top: messagesDiv.scrollHeight, behavior: 'smooth' });
            };

            const updateStatus = (text) => {
                if (text) {
                    statusText.textContent = text;
                    statusBar.classList.remove("hidden");
                } else {
                    statusBar.classList.add("hidden");
                }
            };

            const addMessage = (text, sender = "bot", isHtml = false, isEmpty = false) => {
                const wrap = document.createElement("div");
                wrap.classList.add("flex", sender === "user" ? "justify-end" : "justify-start", "animate-fade-in");

                const bubble = document.createElement("div");
                bubble.classList.add("message-bubble");

                if (sender === "user") {
                    bubble.classList.add("bg-blue-600", "text-white");
                    bubble.textContent = text; // User text is plain
                } else {
                    bubble.classList.add("bg-white", "text-gray-800", "border", "border-gray-200", "dark:bg-gray-800", "dark:text-gray-100", "dark:border-gray-700");

                    const body = document.createElement("div");
                    body.classList.add("markdown-body");

                    if (!isEmpty) {
                        // Normal behavior
                        body.innerHTML = isHtml ? text : marked.parse(text);

                        // Trigger TTS if it's a new bot message (not history load)
                        // Note: We might need a flag to distinguish history load vs live message
                        // For now, let's assume this is mostly live. 
                        // Actually, this function is called for history too.
                        // We should call speakText separately in the receive handler
                    }

                    bubble.appendChild(body);
                }

                wrap.appendChild(bubble);
                messagesDiv.appendChild(wrap);
                scrollToBottom();
            };

            // Enhanced Typing Animation
            const simulateTyping = (text, element) => {
                let index = 0;
                // Type faster: 10ms per char
                const speed = 10;

                // Disable input while typing
                userInput.disabled = true;
                sendButton.disabled = true;
                updateStatus("Typing...");

                function typeChar() {
                    if (index < text.length) {
                        const chunk = text.slice(0, index + 3);
                        index += 3;
                        element.innerHTML = marked.parse(chunk);
                        scrollToBottom();
                        setTimeout(typeChar, speed);
                    } else {
                        element.innerHTML = marked.parse(text);
                        scrollToBottom();

                        userInput.disabled = false;
                        sendButton.disabled = false;
                        updateStatus(null);
                        userInput.focus();

                        // TTS Trigger after typing finishes
                        speakText(text);
                    }
                }

                typeChar();
            };

            // Typing Indicator Component (No changes needed)
            let typingElement = null;

            const showTyping = () => {
                if (typingElement) return;
                const wrap = document.createElement("div");
                wrap.classList.add("flex", "justify-start", "animate-fade-in");
                wrap.id = "typing-indicator-wrap";
                const bubble = document.createElement("div");
                bubble.classList.add("typing-indicator");
                bubble.innerHTML = `<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>`;
                wrap.appendChild(bubble);
                messagesDiv.appendChild(wrap);
                typingElement = wrap;
                scrollToBottom();
            };

            const hideTyping = () => {
                if (typingElement) {
                    typingElement.remove();
                    typingElement = null;
                }
            };

            /* ================= BACKEND CALL ================= */
            const sendToBackend = async (text) => {
                showTyping();
                updateStatus("Searching knowledge base...");
                sendButton.disabled = true;

                // Simulate "Thinking" stages for better UX
                const statusTimer = setTimeout(() => {
                    updateStatus("Generating response...");
                }, 1500);

                try {
                    const res = await fetch(backendUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            message: text,
                            session_id: sessionId,
                            language: settings.language
                        })
                    });

                    const data = await res.json();

                    // Save session id
                    if (data.session_id) sessionId = data.session_id;

                    clearTimeout(statusTimer);
                    updateStatus(null);
                    hideTyping();

                    if (data.answer) {
                        // Use typing animation for bot response
                        addMessage("", "bot", false, true); // Create empty bubble
                        const bubbles = document.querySelectorAll(".message-bubble");
                        const lastBubbleBody = bubbles[bubbles.length - 1].querySelector(".markdown-body");

                        if (lastBubbleBody) {
                            simulateTyping(data.answer, lastBubbleBody);
                        }
                    } else {
                        addMessage("I couldn't understand that. Please try again.", "bot");
                    }

                } catch (error) {
                    console.error(error);
                    clearTimeout(statusTimer);
                    updateStatus(null);
                    hideTyping();
                    addMessage("‚ö†Ô∏è Unable to connect to the server.", "bot");
                } finally {
                    sendButton.disabled = false;
                    userInput.focus();
                }
            };

            const sendMessage = () => {
                const text = userInput.value.trim();
                if (!text) return;

                addMessage(text, "user");
                userInput.value = "";

                // Slight delay before typing indicator
                setTimeout(() => sendToBackend(text), 300);
            };

            /* ================= EVENTS ================= */
            chatIcon.onclick = toggleChat;
            closeChat.onclick = toggleChat;
            sendButton.onclick = sendMessage;
            userInput.addEventListener("keypress", e => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Language Change Handler (Updated)
            const updatePlaceholder = (lang) => {
                if (lang === 'hi') {
                    userInput.placeholder = "‡§Ö‡§™‡§®‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç...";
                } else if (lang === 'te') {
                    userInput.placeholder = "‡∞Æ‡±Ä ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞®‡±Å ‡∞ü‡±à‡∞™‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø...";
                } else {
                    userInput.placeholder = "Type your question...";
                }
            };

            languageSelect.addEventListener("change", () => {
                settings.language = languageSelect.value;
                updatePlaceholder(settings.language);
                saveSettings();
            });

            // Voice Input Handler (Updated)
            const micButton = document.getElementById("mic-button");

            if ('webkitSpeechRecognition' in window) {
                const recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;

                micButton.onclick = () => {
                    const lang = settings.language;
                    if (lang === 'hi') recognition.lang = 'hi-IN';
                    else if (lang === 'te') recognition.lang = 'te-IN';
                    else recognition.lang = 'en-US';

                    recognition.start();
                    userInput.placeholder = "Listening...";
                    micButton.classList.add("text-red-500", "animate-pulse");
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    userInput.value = transcript;
                    sendMessage();
                };

                recognition.onend = () => {
                    micButton.classList.remove("text-red-500", "animate-pulse");
                    updatePlaceholder(settings.language);
                };

                recognition.onerror = (event) => {
                    console.error("Speech recognition error", event.error);
                    micButton.classList.remove("text-red-500", "animate-pulse");
                    updatePlaceholder(settings.language);
                };
            } else {
                micButton.style.display = 'none'; // Hide if not supported
                console.log("Web Speech API not supported");
            }

            // Init
            loadSettings();

            // Configure Marked
            marked.setOptions({
                breaks: true, // Enable line breaks
                gfm: true     // Enable GitHub Flavored Markdown
            });

        });
    </script>

</body>

</html>